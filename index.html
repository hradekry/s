<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Routine OS">
    <link rel="manifest" href="/manifest.json">
    <title>Routine OS</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:#000;color:#fff;font-family:'Helvetica Neue Condensed','Helvetica Condensed',Helvetica,Arial,sans-serif;min-height:100vh;-webkit-font-smoothing:antialiased;font-stretch:condensed}
        ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:#0a0a0a}::-webkit-scrollbar-thumb{background:#a855f7;border-radius:2px}
        .header{background:#0a0a0a;border-bottom:0.5px solid rgba(168,85,247,.4);padding:12px 16px;position:sticky;top:0;z-index:30;box-shadow:0 1px 3px rgba(0,0,0,.3)}
        .header-inner{display:flex;align-items:center;justify-content:space-between;max-width:448px;margin:0 auto}
        .header-left{display:flex;align-items:center;gap:12px}
        .header h1{font-size:18px;font-weight:600}.header .sub{font-size:13px;color:#9ca3af;margin-top:1px}
        .icon-btn{width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:none;border:none;color:#a855f7;cursor:pointer;border-radius:6px;transition:background .2s}
        .icon-btn:hover{background:rgba(168,85,247,.1)}
        .main{padding:20px 16px;max-width:480px;margin:0 auto;padding-bottom:40px}
        .section{margin-bottom:28px}
        .section-title{font-size:13px;font-weight:600;color:#9ca3af;margin-bottom:16px;text-transform:uppercase;letter-spacing:.8px}
        .card{background:#0a0a0a;border:0.5px solid rgba(168,85,247,.5);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.2)}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;background:#1a1a1a;border:0.5px solid rgba(168,85,247,.5);border-radius:12px;overflow:hidden;padding:2px;box-shadow:0 2px 8px rgba(0,0,0,.2)}
        .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
        .cal-nav{display:flex;align-items:center;gap:12px}
        .cal-btn{min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;background:rgba(168,85,247,.08);border:0.5px solid rgba(168,85,247,.4);color:#a855f7;cursor:pointer;border-radius:8px;font-size:14px;font-weight:600;transition:all .2s}
        .cal-btn:hover{background:rgba(168,85,247,.2)}
        .cal-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:14px;background:#000;cursor:pointer;transition:all .2s;position:relative;border-radius:6px;font-weight:500}
        .cal-day:hover{background:#1a1a1a;transform:scale(1.05)}
        .cal-day.other-month{color:#4b5563;opacity:.5}
        .cal-day.today{background:#a855f7;color:#000;font-weight:700;box-shadow:0 0 0 2px rgba(168,85,247,.3)}
        .cal-day.selected{background:#d8b4fe;color:#000;font-weight:600}
        .cal-day.has-events::after{content:'';position:absolute;bottom:4px;width:5px;height:5px;background:#a855f7;border-radius:50%;box-shadow:0 0 4px rgba(168,85,247,.6)}
        .weekday{font-size:10px;color:#6b7280;text-align:center;padding:8px 0;background:#0a0a0a;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
        .events-list{display:flex;flex-direction:column;gap:10px}
        .event-item{display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(168,85,247,.04);border:0.5px solid rgba(168,85,247,.25);border-radius:8px;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.1)}
        .event-item:hover{background:rgba(168,85,247,.1);border-color:#a855f7}
        .event-info{flex:1}
        .event-time{font-size:11px;color:#a855f7;margin-bottom:4px;font-weight:600}
        .event-title{font-size:14px;color:#fff;font-weight:500;margin-bottom:2px}
        .event-type{font-size:10px;color:#9ca3af;text-transform:uppercase;letter-spacing:.5px}
        .del-btn{min-width:36px;min-height:36px;display:flex;align-items:center;justify-content:center;background:rgba(239,68,68,.08);border:0.5px solid rgba(239,68,68,.3);color:#ef4444;cursor:pointer;border-radius:6px;transition:all .2s}.del-btn:hover{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.6)}
        .setting-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.06)}
        .setting-row:last-child{border-bottom:none}
        .toggle{position:relative;display:inline-block;width:44px;height:24px}
        .toggle input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#111;border:1px solid rgba(168,85,247,.4);transition:.2s;border-radius:999px}
        .toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;top:2px;background:#a855f7;transition:.2s;border-radius:50%}
        .toggle input:checked + .toggle-slider{background:rgba(168,85,247,.2)}
        .toggle input:checked + .toggle-slider:before{transform:translateX(20px)}
        .metrics-grid{display:grid;grid-template-columns:1fr;gap:16px}
        .metric-card{background:#0a0a0a;border:0.5px solid rgba(168,85,247,.5);border-radius:12px;padding:16px;transition:all .2s;box-shadow:0 2px 6px rgba(0,0,0,.15)}
        .metric-card:hover{border-color:#d8b4fe;box-shadow:0 4px 12px rgba(168,85,247,.15)}
        .metric-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
        .metric-title{font-size:14px;font-weight:600;color:#d1d5db}
        .metric-value{font-size:16px;color:#a855f7;font-weight:700}
        .metric-actions{display:flex;gap:10px;margin-top:12px}
        .metric-btn{flex:1;min-height:38px;padding:8px 10px;background:rgba(168,85,247,.08);border:0.5px solid rgba(168,85,247,.4);color:#a855f7;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
        .metric-btn:hover{background:rgba(168,85,247,.2);transform:translateY(-1px)}
        .metric-btn.done{background:#a855f7;color:#000;border-color:#a855f7}
        .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;justify-content:center;z-index:50}
        .overlay.open{display:flex}
        .modal{background:#0a0a0a;border-top:1px solid #a855f7;width:100%;max-width:448px;border-radius:12px 12px 0 0;max-height:85vh;display:flex;flex-direction:column}
        .modal-head{padding:14px 16px;border-bottom:1px solid rgba(168,85,247,.2);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
        .modal-head h2{font-size:16px;font-weight:600}
        .modal-body{flex:1;overflow-y:auto;padding:16px}
        .modal-foot{padding:12px 16px;border-top:1px solid rgba(168,85,247,.2);flex-shrink:0}
        .close{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:none;border:none;color:#9ca3af;cursor:pointer}.close:hover{color:#fff}
        .fg{margin-bottom:14px}.fl{display:block;font-size:13px;font-weight:500;color:#d1d5db;margin-bottom:6px}
        .fi,.ft{width:100%;padding:8px 12px;background:#000;border:0.5px solid rgba(168,85,247,.5);border-radius:8px;color:#fff;font-size:14px;font-family:inherit;color-scheme:dark}
        .fi:focus,.ft:focus{outline:none;border-color:#d8b4fe}.ft{resize:none;min-height:64px}
        .type-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .tbtn{padding:8px 12px;background:#000;border:0.5px solid rgba(168,85,247,.4);border-radius:8px;color:#d1d5db;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .2s;font-family:inherit;font-size:13px}
        .tbtn.on{background:#a855f7;color:#fff}
        .form-acts{display:flex;gap:8px;margin-top:14px}
        .fbtn{flex:1;padding:12px 16px;border-radius:10px;border:0.5px solid rgba(168,85,247,.5);cursor:pointer;font-size:14px;font-weight:600;transition:all .2s;font-family:inherit;min-height:48px}
        .fbtn-c{background:#000;color:#d1d5db;border-color:#4b5563}.fbtn-c:hover{background:#1a1a1a;border-color:#6b7280}
        .fbtn-s{background:#a855f7;color:#fff;border-color:#a855f7}.fbtn-s:hover{background:#9333ea;transform:translateY(-1px);box-shadow:0 4px 12px rgba(168,85,247,.3)}.fbtn-s:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:#a855f7;border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(168,85,247,.3);transition:background .2s;z-index:40}
        .fab:hover{background:#9333ea}
        .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;color:#6b7280;background:rgba(168,85,247,.02);border-radius:12px;border:0.5px dashed rgba(168,85,247,.25)}
        .empty-state svg{width:40px;height:40px;margin-bottom:12px;opacity:.5}
        .empty-state p{font-size:13px;font-weight:500}
        .coach-section{background:#0a0a0a;border:0.5px solid rgba(168,85,247,.5);border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.2)}
        .coach-header{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid rgba(168,85,247,.2);background:rgba(168,85,247,.03)}
        .coach-label{font-size:15px;font-weight:600;color:#fff;display:flex;align-items:center;gap:8px}
        .coach-label svg{color:#a855f7}
        .coach-status{font-size:10px;color:#22c55e;padding:4px 10px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);border-radius:6px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
        .coach-log{max-height:400px;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
        .coach-msg{padding:12px 14px;border-radius:10px;font-size:13px;line-height:1.7;color:#e5e7eb}
        .coach-msg.coach-resp{background:rgba(168,85,247,.05);border-left:3px solid #a855f7}
        .coach-msg.coach-resp.harsh{background:rgba(239,68,68,.05);border-left-color:#ef4444}
        .coach-msg.coach-resp.motivate{background:rgba(245,158,11,.05);border-left-color:#f59e0b}
        .coach-msg.coach-resp.advice{background:rgba(34,197,94,.05);border-left-color:#22c55e}
        .coach-msg.user-cmd{background:rgba(168,85,247,.1);border:1px solid rgba(168,85,247,.3);text-align:right;border-radius:10px}
        .coach-tag{font-size:9px;text-transform:uppercase;letter-spacing:.8px;font-weight:700;margin-bottom:6px;color:#a855f7}
        .coach-msg.harsh .coach-tag{color:#f87171}
        .coach-msg.motivate .coach-tag{color:#fbbf24}
        .coach-msg.advice .coach-tag{color:#4ade80}
        .coach-input-row{display:flex;gap:10px;padding:14px 16px;border-top:1px solid rgba(168,85,247,.2);background:rgba(168,85,247,.02)}
        .coach-input{flex:1;padding:12px 14px;background:#000;border:0.5px solid rgba(168,85,247,.5);border-radius:10px;color:#fff;font-size:14px;font-family:inherit;transition:all .2s}
        .coach-input:focus{outline:none;border-color:#d8b4fe;box-shadow:0 0 0 3px rgba(168,85,247,.1)}
        .coach-send{min-width:48px;min-height:48px;display:flex;align-items:center;justify-content:center;background:#a855f7;border:none;border-radius:10px;color:#fff;cursor:pointer;transition:all .2s}
        .coach-send:hover{background:#9333ea;transform:scale(1.05)}
        .coach-mic{min-width:48px;min-height:48px;display:flex;align-items:center;justify-content:center;background:rgba(168,85,247,.08);border:0.5px solid rgba(168,85,247,.4);border-radius:10px;color:#a855f7;cursor:pointer;transition:all .2s}
        .coach-mic:hover{background:rgba(168,85,247,.2);border-color:#a855f7;transform:scale(1.02)}
        .coach-mic.active{background:#a855f7;color:#000}
        .coach-quick{display:flex;gap:8px;padding:12px 16px;flex-wrap:wrap;border-bottom:1px solid rgba(168,85,247,.1)}
        .coach-quick-btn{padding:6px 12px;background:rgba(168,85,247,.06);border:0.5px solid rgba(168,85,247,.3);color:#d8b4fe;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit;text-transform:uppercase;letter-spacing:.5px}
        .coach-quick-btn:hover{background:rgba(168,85,247,.15);border-color:#a855f7;transform:translateY(-1px)}
        .feedback-banner{position:fixed;top:70px;left:16px;right:16px;max-width:416px;margin:0 auto;z-index:35;background:rgba(127,29,29,.4);border:2px solid #ef4444;border-radius:8px;padding:12px 16px;display:none;cursor:pointer;animation:pulse 2s infinite;box-shadow:0 4px 12px rgba(239,68,68,.3)}
        .feedback-banner.show{display:flex;align-items:center;gap:10px}
        .feedback-banner span{font-size:13px;color:#fef2f2;font-weight:600}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.8}}
        .context-switcher svg{width:20px;height:20px}
        .view-container{display:none;animation:fadeIn .2s ease-out}
        .view-container.active{display:block}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .task-done{opacity:.5}
        .task-skipped{opacity:.4}
        .task-skipped .event-title{color:#6b7280;text-decoration:line-through}
        .task-status.skipped{color:#f59e0b;background:rgba(245,158,11,.1)}
        .task-done .event-title{text-decoration:line-through;color:#6b7280}
        .task-status{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:2px 6px;border-radius:4px;display:inline-block;margin-top:4px}
        .task-status.completed{color:#22c55e;background:rgba(34,197,94,.1)}
        .task-status.active{color:#a855f7;background:rgba(168,85,247,.1)}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-inner">
            <div class="header-left">
                <div>
                    <h1 id="contextTitle">Calendar</h1>
                    <div class="sub" id="contextSubtitle">Today</div>
                </div>
            </div>
            <button class="icon-btn context-switcher" id="contextSwitcher" onclick="cycleContext()" aria-label="Switch context">
                <svg id="contextIcon" viewBox="0 0 24 24" fill="none"></svg>
            </button>
        </div>
    </header>

    <main class="main">
        <!-- Calendar View -->
        <div id="calendarView" class="view-container active">
            <!-- Calendar Section -->
            <section class="section">
                <div class="cal-header">
                    <h2 class="section-title" id="currentMonth" style="margin:0">Loading...</h2>
                    <div class="cal-nav">
                        <button class="cal-btn" onclick="previousMonth()">‹</button>
                        <button class="cal-btn" onclick="nextMonth()">›</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar">
                    <!-- Calendar will be rendered here -->
                </div>
            </section>

            <!-- Events Section -->
            <section class="section">
                <h2 class="section-title">Events for <span id="eventsDate">Today</span></h2>
                <div class="card">
                    <div class="events-list" id="eventsList">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><polyline points="12 6 12 12 16 14" stroke="currentColor" stroke-width="2"/></svg>
                            <p>No events for this day</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Tasks View -->
        <div id="tasksView" class="view-container">
            <section class="section">
                <h2 class="section-title">Daily Tasks</h2>
                <div class="card">
                    <div id="tasksList">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none"><path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            <p>No tasks for today</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Metrics View -->
        <div id="metricsView" class="view-container">
            <section class="section">
                <h2 class="section-title">Health Metrics</h2>
                <div class="metrics-grid" id="metricsGrid">
                    <!-- Metrics will be rendered here -->
                </div>
            </section>
        </div>

        <!-- Coach View -->
        <div id="coachView" class="view-container">
            <section class="section">
                <h2 class="section-title">The Coach</h2>
                <div class="coach-section">
                    <div class="coach-header">
                        <div class="coach-label">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M14.5 17.5L3 6V3h3l11.5 11.5M13 7l4-4 4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            The Coach
                        </div>
                        <span class="coach-status" id="coachStatus">Active</span>
                    </div>
                    <div class="coach-log" id="coachLog"></div>
                    <div class="coach-quick">
                        <button class="coach-quick-btn" onclick="coachCommand('review progress')">Progress</button>
                        <button class="coach-quick-btn" onclick="coachCommand('recommend')">Recommend</button>
                        <button class="coach-quick-btn" onclick="coachCommand('motivate me')">Motivate</button>
                        <button class="coach-quick-btn" onclick="coachCommand('sleep hygiene')">Sleep</button>
                        <button class="coach-quick-btn" onclick="coachCommand('work density')">Work</button>
                    </div>
                    <div class="coach-input-row">
                        <input type="text" class="coach-input" id="coachInput" placeholder="Command the Coach...">
                        <button class="coach-mic" id="coachMic" onclick="toggleVoiceInput()" title="Voice input">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="9" y="2" width="6" height="12" rx="3" stroke="currentColor" stroke-width="2"/><path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="currentColor" stroke-width="2"/><line x1="12" y1="19" x2="12" y2="22" stroke="currentColor" stroke-width="2"/><line x1="8" y1="22" x2="16" y2="22" stroke="currentColor" stroke-width="2"/></svg>
                        </button>
                        <button class="coach-send" onclick="sendCoachCommand()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><line x1="22" y1="2" x2="11" y2="13" stroke="currentColor" stroke-width="2"/><polygon points="22 2 15 22 11 13 2 9 22 2" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                        </button>
                    </div>
                </div>
            </section>
            <section class="section">
                <h2 class="section-title">Quiet Mode</h2>
                <div class="card">
                    <div class="setting-row">
                        <div>
                            <div style="font-size:13px;font-weight:600;">Notifications</div>
                            <div style="font-size:11px;color:#9ca3af;">Allow system notifications</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="settingNotifications" onchange="toggleSetting('notifications', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <div>
                            <div style="font-size:13px;font-weight:600;">Alarms</div>
                            <div style="font-size:11px;color:#9ca3af;">Allow alarm sound</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="settingAlarms" onchange="toggleSetting('alarms', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Feedback Banner -->
    <div class="feedback-banner" id="feedbackBanner" onclick="dismissFeedback()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M14.5 17.5L3 6V3h3l11.5 11.5M13 7l4-4 4 4-4 4" stroke="#f87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span id="feedbackBannerText">The Coach has words for you.</span>
    </div>

    <!-- Context-Aware FAB -->
    <button class="fab" id="contextFab" onclick="handleFabClick()" aria-label="Add">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"/>
        </svg>
    </button>

    <!-- Add Event Modal -->
    <div class="overlay" id="addModal">
        <div class="modal">
            <div class="modal-head">
                <h2>Add Event</h2>
                <button class="close" onclick="closeAll()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"/></svg></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="fg"><label class="fl">Title *</label><input class="fi" id="eventTitle" placeholder="Enter title" required></div>
                    <div class="fg"><label class="fl">Description</label><textarea class="ft" id="eventDesc" placeholder="Optional"></textarea></div>
                    <div class="fg"><label class="fl">Date</label><input type="date" class="fi" id="eventDate"></div>
                    <div class="fg"><label class="fl">Time</label><input type="time" class="fi" id="eventTime"></div>
                    <div class="fg">
                        <label class="fl">Alarm Sound</label>
                        <div class="setting-row" style="border:none;padding:6px 0">
                            <div style="display:flex;align-items:center;gap:10px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="color:#a855f7;flex-shrink:0"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                <span style="font-size:13px;color:#d1d5db">Play alarm sound</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="eventAlarmToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="fg"><label class="fl">Type</label>
                        <div class="type-grid">
                            <button type="button" class="tbtn on" data-type="onetime" onclick="pickEventType(this)">One-time</button>
                            <button type="button" class="tbtn" data-type="recurring" onclick="pickEventType(this)">Daily</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-foot">
                <button class="fbtn fbtn-c" onclick="closeAll()">Cancel</button>
                <button class="fbtn fbtn-s" onclick="saveEvent()">Add Event</button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="overlay" id="taskModal">
        <div class="modal">
            <div class="modal-head">
                <h2>Add Task</h2>
                <button class="close" onclick="closeAll()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"/></svg></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="fg">
                        <label class="fl">Task Title *</label>
                        <input class="fi" id="taskTitle" placeholder="What needs to be done?" required>
                    </div>
                    <div class="fg">
                        <label class="fl">Description (Optional)</label>
                        <textarea class="ft" id="taskDesc" placeholder="Add details..." rows="3"></textarea>
                    </div>
                    <div class="fg">
                        <label class="fl">Task Type</label>
                        <div class="type-grid">
                            <button type="button" class="tbtn on" data-type="onetime" onclick="pickTaskType(this)">One-time</button>
                            <button type="button" class="tbtn" data-type="recurring" onclick="pickTaskType(this)">Daily</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-foot">
                <button class="fbtn fbtn-c" onclick="closeAll()">Cancel</button>
                <button class="fbtn fbtn-s" onclick="saveTask()">Add Task</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="overlay" id="editTaskModal">
        <div class="modal">
            <div class="modal-head">
                <h2>Edit Task</h2>
                <button class="close" onclick="closeAll()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"/></svg></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <div class="fg">
                        <label class="fl">Task Title *</label>
                        <input class="fi" id="editTaskTitle" placeholder="Task title" required>
                    </div>
                    <div class="fg">
                        <label class="fl">Description (Optional)</label>
                        <textarea class="ft" id="editTaskDesc" placeholder="Add details..." rows="3"></textarea>
                    </div>
                    <div class="fg">
                        <label class="fl">Task Type</label>
                        <div class="type-grid">
                            <button type="button" class="tbtn on" data-type="onetime" onclick="pickEditTaskType(this)">One-time</button>
                            <button type="button" class="tbtn" data-type="recurring" onclick="pickEditTaskType(this)">Daily</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-foot">
                <button class="fbtn fbtn-c" onclick="closeAll()">Cancel</button>
                <button class="fbtn fbtn-s" onclick="saveEditTask()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // State Management
        let dataLoaded = false;
        let currentDate = new Date();
        let selectedDate = new Date();
        let events = [];
        let metrics = {
            water: { current: 0, target: 2000 },
            sleep: { hours: null },
            exercise: { done: false }
        };
        let selectedEventType = 'onetime';
        let selectedTaskType = 'onetime';
        let editingTaskId = null;
        let appSettings = {
            notificationsEnabled: true,
            alarmsEnabled: true
        };
        
        
        // Context Switching State
        let currentContext = 'calendar';
        let tasks = [];
        
        const CONTEXTS = {
            calendar: {
                title: 'Calendar',
                subtitle: 'Today',
                icon: '<rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/><line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2"/><line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2"/><line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>'
            },
            tasks: {
                title: 'Tasks',
                subtitle: 'Daily Checklist',
                icon: '<path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>'
            },
            metrics: {
                title: 'Metrics',
                subtitle: 'Health Tracking',
                icon: '<path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>'
            },
            coach: {
                title: 'Coach',
                subtitle: 'AI Assistant',
                icon: '<path d="M14.5 17.5L3 6V3h3l11.5 11.5M13 7l4-4 4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>'
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            
            // Set initial context
            document.querySelectorAll('.view-container').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(currentContext + 'View').classList.add('active');
            
            // Update header and switcher icon
            const ctx = CONTEXTS[currentContext];
            document.getElementById('contextTitle').textContent = ctx.title;
            document.getElementById('contextSubtitle').textContent = ctx.subtitle;
            document.getElementById('contextIcon').innerHTML = ctx.icon;
            
            // Restore selected date if available
            const storedSelectedDate = localStorage.getItem('routine-os-selected-date');
            if (storedSelectedDate) {
                const parsedDate = new Date(storedSelectedDate);
                if (!isNaN(parsedDate.getTime())) {
                    selectedDate = parsedDate;
                    currentDate = new Date(parsedDate);
                }
            }

            // Initialize settings toggles
            const notifToggle = document.getElementById('settingNotifications');
            const alarmToggle = document.getElementById('settingAlarms');
            if (notifToggle) notifToggle.checked = appSettings.notificationsEnabled;
            if (alarmToggle) alarmToggle.checked = appSettings.alarmsEnabled;

            // Render initial content
            renderContextContent(currentContext);

            dataLoaded = true;

            // Start intervals AFTER data is loaded
            setInterval(checkAutoFeedback, 60000);
            checkAutoFeedback();
            setInterval(checkAlarms, 30000);
            checkAlarms();
            setInterval(checkEventAlarms, 30000);
            checkEventAlarms();
            renderCoachLog();

            document.getElementById('coachInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendCoachCommand();
            });
        });

        // Data Persistence (IndexedDB + localStorage fallback)
        const DB_NAME = 'routine-os-db';
        const DB_VERSION = 1;
        const STORE_NAME = 'kv';

        function openDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function idbGet(key) {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const req = store.get(key);
                req.onsuccess = () => resolve(req.result ?? null);
                req.onerror = () => reject(req.error);
            });
        }

        async function idbSet(key, value) {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const req = store.put(value, key);
                req.onsuccess = () => resolve(true);
                req.onerror = () => reject(req.error);
            });
        }

        async function requestPersistentStorage() {
            if (navigator.storage && navigator.storage.persist) {
                try {
                    const persisted = await navigator.storage.persist();
                    console.log('Storage persist:', persisted);
                } catch (e) {
                    console.warn('Persist request failed', e);
                }
            }
        }

        async function loadData() {
            try {
                requestPersistentStorage();

                // Try IndexedDB first, fall back to localStorage
                let storedEvents, storedMetrics, storedTasks, storedContext, storedSelectedDate, storedSettings;
                try {
                    storedEvents = await idbGet('routine-os-events');
                    storedMetrics = await idbGet('routine-os-metrics');
                    storedTasks = await idbGet('routine-os-tasks');
                    storedContext = await idbGet('routine-os-context');
                    storedSelectedDate = await idbGet('routine-os-selected-date');
                    storedSettings = await idbGet('routine-os-settings');
                } catch (idbErr) {
                    console.warn('IndexedDB load failed, using localStorage:', idbErr);
                }
                // Fall back to localStorage for any missing values
                if (!storedEvents) storedEvents = localStorage.getItem('routine-os-events');
                if (!storedMetrics) storedMetrics = localStorage.getItem('routine-os-metrics');
                if (!storedTasks) storedTasks = localStorage.getItem('routine-os-tasks');
                if (!storedContext) storedContext = localStorage.getItem('routine-os-context');
                if (!storedSettings) storedSettings = localStorage.getItem('routine-os-settings');
                
                if (storedEvents) {
                    events = JSON.parse(storedEvents);
                    // Validate and clean events data
                    events = events.filter(e => e && e.id && e.title && e.date);
                    events.forEach(event => {
                        if (typeof event.alarmEnabled !== 'boolean') event.alarmEnabled = false;
                        if (!event.alarmTimestamp) event.alarmTimestamp = null;
                        if (typeof event.alarmNotified !== 'boolean') event.alarmNotified = false;
                    });
                }
                if (storedMetrics) {
                    metrics = JSON.parse(storedMetrics);
                    // Ensure metrics structure is complete
                    if (!metrics.water) metrics.water = { current: 0, target: 2000 };
                    if (!metrics.sleep) metrics.sleep = { hours: null };
                    if (!metrics.exercise) metrics.exercise = { done: false };
                }
                if (storedTasks) {
                    tasks = JSON.parse(storedTasks);
                    // Validate and clean tasks data
                    tasks = tasks.filter(t => t && t.id && t.title && t.date);
                    // Ensure all tasks have required properties
                    tasks.forEach(task => {
                        if (!task.completed) task.completed = false;
                        if (!task.skippedDates) task.skippedDates = [];
                        if (!task.description) task.description = '';
                        if (!task.type) task.type = 'onetime';
                    });
                }
                if (storedContext) {
                    currentContext = storedContext;
                }
                if (storedSelectedDate) {
                    const parsedDate = new Date(storedSelectedDate);
                    if (!isNaN(parsedDate.getTime())) {
                        selectedDate = parsedDate;
                        currentDate = new Date(parsedDate);
                    }
                }
                if (storedSettings) {
                    const parsedSettings = JSON.parse(storedSettings);
                    appSettings = {
                        notificationsEnabled: parsedSettings.notificationsEnabled !== false,
                        alarmsEnabled: parsedSettings.alarmsEnabled !== false
                    };
                }
                
                console.log('Data loaded successfully:', { events: events.length, tasks: tasks.length, metrics, context: currentContext });
            } catch (error) {
                console.error('Error loading data:', error);
                // Reset to defaults if data is corrupted
                events = [];
                tasks = [];
                metrics = {
                    water: { current: 0, target: 2000 },
                    sleep: { hours: null },
                    exercise: { done: false }
                };
                currentContext = 'calendar';
                saveData(); // Save clean defaults
            }
        }

        function saveData() {
            if (!dataLoaded) return; // Don't save until data is loaded
            // Sync localStorage (fast, reliable)
            try {
                localStorage.setItem('routine-os-events', JSON.stringify(events));
                localStorage.setItem('routine-os-metrics', JSON.stringify(metrics));
                localStorage.setItem('routine-os-tasks', JSON.stringify(tasks));
                localStorage.setItem('routine-os-context', currentContext);
                localStorage.setItem('routine-os-selected-date', selectedDate.toISOString());
                localStorage.setItem('routine-os-settings', JSON.stringify(appSettings));
            } catch (e) {
                console.warn('localStorage save failed:', e);
            }

            // Async IndexedDB (persistent, non-blocking)
            try {
                const evJson = JSON.stringify(events);
                const meJson = JSON.stringify(metrics);
                const taJson = JSON.stringify(tasks);
                const sdJson = selectedDate.toISOString();
                Promise.all([
                    idbSet('routine-os-events', evJson),
                    idbSet('routine-os-metrics', meJson),
                    idbSet('routine-os-tasks', taJson),
                    idbSet('routine-os-context', currentContext),
                    idbSet('routine-os-selected-date', sdJson),
                    idbSet('routine-os-settings', JSON.stringify(appSettings))
                ]).catch(err => console.warn('IndexedDB save failed:', err));
            } catch (e) {
                console.warn('IndexedDB save skipped:', e);
            }
        }

        // Auto-save every 30 seconds
        setInterval(saveData, 30000);

        // Save before page unload
        window.addEventListener('beforeunload', saveData);

        // Listen for storage changes from other tabs
        window.addEventListener('storage', (e) => {
            if (e.key && e.key.startsWith('routine-os-')) {
                console.log('Data changed in another tab, reloading...');
                loadData();
                renderContextContent(currentContext);
            }
        });

        function toggleSetting(key, value) {
            if (key === 'notifications') appSettings.notificationsEnabled = value;
            if (key === 'alarms') appSettings.alarmsEnabled = value;
            if (key === 'notifications' && value) requestNotificationPermission();
            saveData();
        }

        let alarmAudioCtx = null;
        let alarmInterval = null;

        function playAlarmSound() {
            if (!appSettings.alarmsEnabled) return;
            stopAlarmSound();
            try {
                alarmAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (alarmAudioCtx.state === 'suspended') alarmAudioCtx.resume();
                let beepCount = 0;
                const maxBeeps = 8;
                function beep() {
                    if (beepCount >= maxBeeps || !alarmAudioCtx) { stopAlarmSound(); return; }
                    const osc = alarmAudioCtx.createOscillator();
                    const gain = alarmAudioCtx.createGain();
                    osc.type = beepCount % 2 === 0 ? 'square' : 'sine';
                    osc.frequency.value = beepCount % 2 === 0 ? 880 : 660;
                    gain.gain.value = 0.35;
                    gain.gain.setTargetAtTime(0, alarmAudioCtx.currentTime + 0.25, 0.05);
                    osc.connect(gain);
                    gain.connect(alarmAudioCtx.destination);
                    osc.start();
                    osc.stop(alarmAudioCtx.currentTime + 0.3);
                    beepCount++;
                }
                beep();
                alarmInterval = setInterval(beep, 500);
            } catch (e) {
                console.warn('Alarm sound failed:', e);
            }
        }

        function stopAlarmSound() {
            if (alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; }
            if (alarmAudioCtx) { alarmAudioCtx.close().catch(() => {}); alarmAudioCtx = null; }
        }

        // Calendar Functions
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            const startDay = firstDay.getDay();
            const endDay = lastDay.getDate();
            const prevEndDay = prevLastDay.getDate();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

            let html = '';
            
            // Weekday headers
            const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            weekdays.forEach(day => {
                html += `<div class="weekday">${day}</div>`;
            });

            // Previous month days
            for (let i = startDay - 1; i >= 0; i--) {
                html += `<div class="cal-day other-month">${prevEndDay - i}</div>`;
            }

            // Current month days
            const today = new Date();
            for (let day = 1; day <= endDay; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDateKey(date);
                const dayEvents = events.filter(e => e.date === dateStr);
                const isToday = date.toDateString() === today.toDateString();
                const isSelected = date.toDateString() === selectedDate.toDateString();
                
                let classes = 'cal-day';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';
                if (dayEvents.length > 0) classes += ' has-events';
                
                html += `<div class="${classes}" onclick="selectDate(${year}, ${month}, ${day})">${day}</div>`;
            }

            // Next month days
            const remainingDays = 42 - (startDay + endDay);
            for (let day = 1; day <= remainingDays; day++) {
                html += `<div class="cal-day other-month">${day}</div>`;
            }

            document.getElementById('calendar').innerHTML = html;
        }

        function selectDate(year, month, day) {
            selectedDate = new Date(year, month, day);
            updateDateDisplay();
            renderEvents();
            renderCalendar();
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function goToToday() {
            const today = new Date();
            currentDate = new Date(today);
            selectedDate = new Date(today);
            updateDateDisplay();
            renderCalendar();
            renderEvents();
        }

        function updateDateDisplay() {
            document.getElementById('eventsDate').textContent = selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Events Functions
        function renderEvents() {
            const dateStr = formatDateKey(selectedDate);
            const dayEvents = events.filter(e => e.date === dateStr);
            const container = document.getElementById('eventsList');

            if (dayEvents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><polyline points="12 6 12 12 16 14" stroke="currentColor" stroke-width="2"/></svg>
                        <p>No events for this day</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = dayEvents.map(event => `
                <div class="event-item">
                    <div class="event-info">
                        ${event.time ? `<div class="event-time">${event.time}</div>` : ''}
                        <div class="event-title">${event.title}</div>
                        ${event.description ? `<div class="event-type">${event.description}</div>` : ''}
                        ${event.type === 'recurring' ? '<div class="event-type">Daily</div>' : ''}
                    </div>
                    <button class="del-btn" onclick="deleteEvent('${event.id}')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><polyline points="3 6 5 6 21 6" stroke="currentColor" stroke-width="2"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2"/></svg>
                    </button>
                </div>
            `).join('');
        }

        function openAddEvent() {
            document.getElementById('addModal').classList.add('open');
            // Pre-fill date picker with selected date
            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(selectedDate.getDate()).padStart(2, '0');
            document.getElementById('eventDate').value = `${year}-${month}-${day}`;
            document.getElementById('eventTime').value = '08:00';
            document.getElementById('eventTitle').focus();
        }

        function closeAll() {
            document.querySelectorAll('.overlay').forEach(o => o.classList.remove('open'));
            const ef = document.getElementById('eventForm');
            if (ef) ef.reset();
            const tf = document.getElementById('taskForm');
            if (tf) tf.reset();
            const etf = document.getElementById('editTaskForm');
            if (etf) etf.reset();
            selectedEventType = 'onetime';
            selectedTaskType = 'onetime';
            document.querySelectorAll('#eventForm .tbtn').forEach(b => b.classList.remove('on'));
            const defaultEventBtn = document.querySelector('#eventForm .tbtn[data-type="onetime"]');
            if (defaultEventBtn) defaultEventBtn.classList.add('on');
            document.querySelectorAll('#taskForm .tbtn').forEach(b => b.classList.remove('on'));
            const defaultTaskBtn = document.querySelector('#taskForm .tbtn[data-type="onetime"]');
            if (defaultTaskBtn) defaultTaskBtn.classList.add('on');
            document.querySelectorAll('#editTaskForm .tbtn').forEach(b => b.classList.remove('on'));
            const defaultEditTaskBtn = document.querySelector('#editTaskForm .tbtn[data-type="onetime"]');
            if (defaultEditTaskBtn) defaultEditTaskBtn.classList.add('on');
        }

        function pickEventType(btn) {
            selectedEventType = btn.dataset.type;
            document.querySelectorAll('#eventForm .tbtn').forEach(b => b.classList.remove('on'));
            btn.classList.add('on');
        }

        function pickTaskType(btn) {
            selectedTaskType = btn.dataset.type;
            document.querySelectorAll('#taskForm .tbtn').forEach(b => b.classList.remove('on'));
            btn.classList.add('on');
        }

        function pickEditTaskType(btn) {
            if (!editingTaskId) return;
            const modal = document.getElementById('editTaskForm');
            modal.querySelectorAll('.tbtn').forEach(b => b.classList.remove('on'));
            btn.classList.add('on');
        }

        function getSelectedType(formSelector) {
            const active = document.querySelector(`${formSelector} .tbtn.on`);
            return active ? active.dataset.type : 'onetime';
        }

        function saveEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            if (!title) return;

            // Get date from date picker or use selected date
            const eventDateInput = document.getElementById('eventDate').value;
            let eventDate;
            if (eventDateInput) {
                eventDate = eventDateInput; // Already in YYYY-MM-DD format
            } else {
                eventDate = formatDateKey(selectedDate);
            }

            const eventTime = document.getElementById('eventTime').value;
            const alarmEnabled = document.getElementById('eventAlarmToggle').checked;
            let alarmTimestamp = null;
            let alarmNotified = false;
            if (eventTime) {
                const [h, m] = eventTime.split(':').map(v => parseInt(v, 10));
                const now = new Date();
                const alarmDate = new Date(eventDate);
                alarmDate.setHours(h, m, 0, 0);
                if (alarmDate <= now) alarmDate.setDate(alarmDate.getDate() + 1);
                alarmTimestamp = alarmDate.getTime();
                if (appSettings.notificationsEnabled) requestNotificationPermission();
            }

            const event = {
                id: Date.now().toString(),
                title,
                description: document.getElementById('eventDesc').value.trim(),
                time: eventTime,
                type: selectedEventType,
                date: eventDate,
                alarmEnabled: !!alarmEnabled,
                alarmTimestamp,
                alarmNotified
            };

            events.push(event);
            saveData();
            renderEvents();
            renderCalendar();
            closeAll();
        }

        function deleteEvent(id) {
            events = events.filter(e => e.id !== id);
            saveData();
            renderEvents();
            renderCalendar();
        }

        // Health Metrics Functions
        function renderMetrics() {
            const container = document.getElementById('metricsGrid');
            const waterPercent = Math.round((metrics.water.current / metrics.water.target) * 100);
            container.innerHTML = `
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Water Intake</span>
                        <span class="metric-value">${metrics.water.current}ml / ${metrics.water.target}ml</span>
                    </div>
                    <div class="metric-actions">
                        <button class="metric-btn" onclick="addWater(250)">+250ml</button>
                        <button class="metric-btn" onclick="addWater(500)">+500ml</button>
                        <button class="metric-btn" onclick="resetWater()">Reset</button>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Sleep Duration</span>
                        <span class="metric-value">${metrics.sleep.hours ? metrics.sleep.hours + ' hours' : 'Not set'}</span>
                    </div>
                    <div class="metric-actions">
                        <input type="number" class="fi" id="sleepInput" placeholder="Hours" min="0" max="24" step="0.5" style="flex:1">
                        <button class="metric-btn" onclick="setSleep()">Set</button>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Exercise</span>
                        <span class="metric-value">${metrics.exercise.done ? 'Done ✅' : 'Not done'}</span>
                    </div>
                    <div class="metric-actions">
                        <button class="metric-btn ${metrics.exercise.done ? 'done' : ''}" onclick="toggleExercise()">${metrics.exercise.done ? 'Mark as Not Done' : 'Mark as Done'}</button>
                    </div>
                </div>
            `;

            const sleepInput = document.getElementById('sleepInput');
            if (sleepInput) {
                sleepInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') setSleep();
                });
            }
        }

        function updateMetrics() {
            renderMetrics();
        }

        function addWater(amount) {
            metrics.water.current = Math.min(metrics.water.current + amount, metrics.water.target);
            saveData();
            updateMetrics();
        }

        function resetWater() {
            metrics.water.current = 0;
            saveData();
            updateMetrics();
        }

        function setSleep() {
            const hours = parseFloat(document.getElementById('sleepInput').value);
            if (hours && hours >= 0 && hours <= 24) {
                metrics.sleep.hours = hours;
                saveData();
                updateMetrics();
                document.getElementById('sleepInput').value = '';
            }
        }

        function toggleExercise() {
            metrics.exercise.done = !metrics.exercise.done;
            saveData();
            updateMetrics();
        }

        // Context Switching Functions
        const CONTEXT_ORDER = ['calendar', 'tasks', 'metrics', 'coach'];

        function setContext(context) {
            currentContext = context;
            saveData();

            document.querySelectorAll('.view-container').forEach(view => {
                view.classList.remove('active');
            });
            const activeView = document.getElementById(context + 'View');
            if (activeView) activeView.classList.add('active');

            const ctx = CONTEXTS[context];
            document.getElementById('contextTitle').textContent = ctx.title;
            document.getElementById('contextSubtitle').textContent = ctx.subtitle;
            document.getElementById('contextIcon').innerHTML = ctx.icon;

            renderContextContent(context);
        }

        function cycleContext() {
            const idx = CONTEXT_ORDER.indexOf(currentContext);
            const next = CONTEXT_ORDER[(idx + 1) % CONTEXT_ORDER.length];
            setContext(next);
        }

        function renderContextContent(context) {
            switch(context) {
                case 'calendar':
                    renderCalendar();
                    renderEvents();
                    updateDateDisplay();
                    break;
                case 'tasks':
                    renderTasks();
                    break;
                case 'metrics':
                    renderMetrics();
                    break;
                case 'coach':
                    renderCoachLog();
                    break;
            }
        }

        // Tasks Functions
        function renderTasks() {
            const container = document.getElementById('tasksList');
            const today = formatDateKey(new Date());
            const todayTasks = tasks.filter(task => task.date === today || task.type === 'recurring');
            
            if (todayTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none"><path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <p>No tasks for today</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = todayTasks.map(task => {
                const skipped = task.skippedDates && task.skippedDates.includes(today);
                const taskClass = skipped ? 'task-skipped' : task.completed ? 'task-done' : '';
                const statusClass = skipped ? 'skipped' : task.completed ? 'completed' : 'active';
                const statusText = skipped ? 'Skipped' : task.completed ? 'Completed' : 'Active';
                const isSkipped = skipped;
                return `
                <div class="event-item ${taskClass}">
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        ${task.type === 'recurring' ? '<div class="task-meta">Daily</div>' : ''}
                        ${task.description ? `<div class="task-desc">${task.description}</div>` : ''}
                        ${isSkipped ? '<span class="badge badge-skip">Skipped</span>' : ''}
                    </div>
                    <div style="display:flex;gap:6px;align-items:center;flex-shrink:0">
                        <button class="del-btn" style="background:rgba(59,130,246,.08);border-color:rgba(59,130,246,.3);color:#60a5fa" onclick="openEditTask('${task.id}')" title="Edit">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 20h9" stroke="currentColor" stroke-width="2"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                        <button class="del-btn" style="background:${task.completed ? 'rgba(34,197,94,.15)' : 'rgba(34,197,94,.08)'};border-color:${task.completed ? '#22c55e' : 'rgba(34,197,94,.3)'};color:#22c55e" onclick="toggleTask('${task.id}')" title="${task.completed ? 'Undo' : 'Complete'}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none">${task.completed ? '<path d="M3 12h18" stroke="currentColor" stroke-width="2"/>' : '<path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>'}</svg>
                        </button>
                        <button class="del-btn" style="background:rgba(245,158,11,.08);border-color:rgba(245,158,11,.3);color:#f59e0b" onclick="skipTask('${task.id}')" title="Skip today">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M13 17l5-5-5-5M6 17l5-5-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                        <button class="del-btn" onclick="deleteTask('${task.id}')" title="Delete">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><polyline points="3 6 5 6 21 6" stroke="currentColor" stroke-width="2"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2"/></svg>
                        </button>
                    </div>
                </div>
            `;}).join('');
        }

        function addTask() {
            document.getElementById('taskModal').classList.add('open');
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDesc').value = '';
            selectedTaskType = 'onetime';
            document.querySelectorAll('#taskForm .tbtn').forEach(b => b.classList.remove('on'));
            const defaultTaskBtn = document.querySelector('#taskForm .tbtn[data-type="onetime"]');
            if (defaultTaskBtn) defaultTaskBtn.classList.add('on');
            document.getElementById('taskTitle').focus();
        }

        function saveTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) {
                alert('Please enter a task title');
                return;
            }

            const taskType = getSelectedType('#taskForm');
            const taskDate = taskType === 'recurring' ? formatDateKey(new Date()) : formatDateKey(new Date());

            const task = {
                id: Date.now().toString(),
                title,
                description: document.getElementById('taskDesc').value.trim(),
                completed: false,
                date: taskDate,
                type: taskType
            };
            
            tasks.push(task);
            saveData();
            renderTasks();
            closeAll();
        }

        function toggleTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                saveData();
                renderTasks();
            }
        }

        function skipTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                // Mark as skipped for today by setting a skip date
                if (!task.skippedDates) task.skippedDates = [];
                const today = formatDateKey(new Date());
                if (!task.skippedDates.includes(today)) {
                    task.skippedDates.push(today);
                }
                saveData();
                renderTasks();
            }
        }

        function deleteTask(taskId) {
            if (confirm('Delete this task permanently?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveData();
                renderTasks();
            }
        }

        function openEditTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            editingTaskId = taskId;
            document.getElementById('editTaskTitle').value = task.title || '';
            document.getElementById('editTaskDesc').value = task.description || '';
            document.querySelectorAll('#editTaskForm .tbtn').forEach(b => b.classList.remove('on'));
            const selectedBtn = document.querySelector(`#editTaskForm .tbtn[data-type="${task.type || 'onetime'}"]`);
            if (selectedBtn) selectedBtn.classList.add('on');
            document.getElementById('editTaskModal').classList.add('open');
            document.getElementById('editTaskTitle').focus();
        }

        function saveEditTask() {
            const task = tasks.find(t => t.id === editingTaskId);
            if (!task) return;
            const title = document.getElementById('editTaskTitle').value.trim();
            if (!title) {
                alert('Please enter a task title');
                return;
            }
            const desc = document.getElementById('editTaskDesc').value.trim();
            const taskType = getSelectedType('#editTaskForm');

            task.title = title;
            task.description = desc;

            task.type = taskType;

            saveData();
            renderTasks();
            closeAll();
        }

        // Context-Aware FAB
        function handleFabClick() {
            switch(currentContext) {
                case 'calendar':
                    openAddEvent();
                    break;
                case 'tasks':
                    addTask();
                    break;
                case 'metrics':
                    // No action for metrics
                    break;
                case 'coach':
                    document.getElementById('coachInput').focus();
                    break;
            }
        }

        // Utility Functions
        function formatDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // Close modals on overlay click
        document.querySelectorAll('.overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeAll();
            });
        });

        // Data Restore Function
        function restoreFromFile() {
            const fileInput = document.getElementById('restoreFile');
            if (!fileInput.files.length) {
                addCoachMessage('No file selected. Please choose a backup file first.', 'harsh');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data || typeof data !== 'object') {
                        throw new Error('Invalid file format');
                    }
                    
                    // Restore data with validation
                    if (data.events && Array.isArray(data.events)) {
                        events = data.events.filter(e => e && e.id && e.title && e.date);
                    }
                    if (data.tasks && Array.isArray(data.tasks)) {
                        tasks = data.tasks.filter(t => t && t.id && t.title && t.date);
                        // Ensure tasks have required properties
                        tasks.forEach(task => {
                            if (!task.completed) task.completed = false;
                            if (!task.skippedDates) task.skippedDates = [];
                            if (!task.description) task.description = '';
                        });
                    }
                    if (data.metrics && typeof data.metrics === 'object') {
                        metrics = {
                            water: { current: 0, target: 2000, ...data.metrics.water },
                            sleep: { hours: null, ...data.metrics.sleep },
                            exercise: { done: false, ...data.metrics.exercise }
                        };
                    }
                    if (data.context && typeof data.context === 'string') {
                        currentContext = data.context;
                    }
                    
                    saveData();
                    renderContextContent(currentContext);
                    
                    const backupDate = data.timestamp ? new Date(data.timestamp).toLocaleDateString() : 'unknown';
                    addCoachMessage(`<strong>DATA RESTORED SUCCESSFULLY</strong><br>• Events: ${events.length}<br>• Tasks: ${tasks.length}<br>• Backup date: ${backupDate}<br><em>Your data has been restored and is ready to use.</em>`, 'success');
                    
                } catch (error) {
                    console.error('Restore error:', error);
                    addCoachMessage('<strong>RESTORE FAILED</strong><br>The file is not a valid backup or is corrupted.<br><em>Please try a different backup file.</em>', 'harsh');
                }
            };
            
            reader.onerror = function() {
                addCoachMessage('<strong>FILE READ ERROR</strong><br>Could not read the selected file.<br><em>Please try again or choose a different file.</em>', 'harsh');
            };
            
            reader.readAsText(file);
        }

        

        // ============================================================
        // COACH ENGINE
        // ============================================================

        let coachLog = [];
        let lastFeedbackHour = -1;

        const MOTIVATIONAL_STORIES = [
            { title: 'Leonidas at Thermopylae', text: '480 BC. 300 Spartans held the pass at Thermopylae against 100,000+ Persians for three days. Leonidas knew it was a suicide mission before he marched. When told Persian arrows would block out the sun, Dienekes replied: "Then we shall fight in the shade." They didn\'t fight because they could win. They fought because standing your ground is what separates men from cowards. What\'s your Thermopylae today? Face it.' },
            { title: 'Marcus Aurelius — Emperor Under Plague', text: 'Marcus Aurelius ruled Rome during the Antonine Plague that killed 5 million. He didn\'t retreat. He sold palace furniture to fund the army rather than raise taxes. He wrote Meditations — not for publication, but as self-discipline notes. "The impediment to action advances action. What stands in the way becomes the way." He governed an empire while writing philosophy at 4 AM. You can\'t handle your schedule?' },
            { title: 'Seneca\'s Exile', text: 'Seneca was exiled to Corsica for 8 years. No wealth, no status, no comfort. Instead of breaking, he wrote some of the most important philosophy in human history. "We suffer more in imagination than in reality." He returned to Rome and became the most powerful advisor in the empire. Your discomfort is not exile. It\'s training. Use it.' },
            { title: 'Epictetus — From Slave to Philosopher', text: 'Epictetus was born a slave. His master broke his leg. He couldn\'t choose his circumstances — but he chose his response. He became the most influential Stoic teacher in Rome. "It\'s not what happens to you, but how you react to it that matters." You have freedom he never had. What\'s your excuse for not using it?' },
            { title: 'Cato\'s March Through the Desert', text: 'Cato the Younger marched his army through the Libyan desert — 1,000 miles on foot. No horses for him. He walked with his men, drank last, ate last. When offered water before his soldiers, he refused: "A leader drinks after his men." Discipline isn\'t convenient. It\'s a standard you hold when no one is watching.' },
            { title: 'The Spartan Boy and the Fox', text: 'A Spartan boy stole a fox and hid it under his cloak. Rather than reveal the theft when caught, he let the fox claw his stomach open. He died without making a sound. Extreme? Yes. But the principle stands: endure discomfort silently. Stop announcing your struggles. Handle them.' },
            { title: 'Hannibal Crossing the Alps', text: '218 BC. Hannibal took 30,000 soldiers, 15,000 horses, and 37 war elephants across the Alps in winter. Half his army died. He did it anyway and defeated Rome on their own soil for 15 years. "We will either find a way, or make one." Your obstacle is not the Alps. It\'s your own weakness. Move.' },
            { title: 'Miyamoto Musashi — 61 Duels, Zero Losses', text: 'Musashi fought his first duel at 13. By 30, he had fought 61 duels and never lost. His secret? "Do nothing that is of no use." He eliminated all wasted motion, all wasted thought. Every action had purpose. Examine your day: how much of it is wasted motion? Cut it. Ruthlessly.' },
            { title: 'Diogenes and Alexander', text: 'Alexander the Great visited Diogenes, who lived in a barrel. "Ask me for anything," said the most powerful man alive. Diogenes replied: "Stand out of my sunlight." He needed nothing from the conqueror of the world. Real strength isn\'t accumulation — it\'s the elimination of dependency. What are you dependent on that you shouldn\'t be?' },
            { title: 'Stockdale Paradox', text: 'Admiral James Stockdale spent 7 years as a POW in Vietnam. Tortured repeatedly. The optimists — "We\'ll be out by Christmas" — broke first. Stockdale survived by confronting brutal reality while maintaining faith in the outcome. "You must never confuse faith that you will prevail with the discipline to confront the most brutal facts." Stop hoping. Start acting.' }
        ];

        const ADVICE_DATABASE = {
            'sleep hygiene': {
                title: 'SLEEP HYGIENE — Non-Negotiable Protocol',
                checklist: [
                    'No screens 60 minutes before bed. Blue light destroys melatonin. No exceptions.',
                    'Room temperature: 18-19°C (65-67°F). Your body needs to cool down to sleep.',
                    'Total darkness. Blackout curtains or eye mask. Any light = degraded sleep.',
                    'No caffeine after 2:00 PM. Half-life is 5-6 hours. Do the math.',
                    'Last meal 3 hours before bed. Digestion and sleep don\'t mix.',
                    'Wake time is non-negotiable. Same time every day including weekends.',
                    'Bed is for sleep only. No phone, no laptop, no TV in bed.'
                ],
                suggestion: 'Move your wake-up time to 5:00 AM. Your body adapts in 4 days. The first 3 days will hurt. That\'s the point — you\'re building discipline, not comfort.'
            },
            'work density': {
                title: 'WORK DENSITY — Maximum Output Protocol',
                checklist: [
                    'Time-block in 90-minute deep work sprints. No multitasking.',
                    'Phone in another room during work blocks. Not on silent — physically removed.',
                    'First work block starts within 30 min of waking. Peak cortisol = peak focus.',
                    'Batch all communication (email, Slack) into 2 windows: 11 AM and 4 PM.',
                    'Define 3 MIT (Most Important Tasks) the night before. Non-negotiable.',
                    'No meetings before noon. Protect your cognitive prime time.',
                    'Track deep work hours daily. If it\'s under 4 hours, you\'re coasting.'
                ],
                suggestion: 'Schedule your hardest task as the first event tomorrow at 5:30 AM. Zero warmup. Attack it cold. Your brain is sharpest before the world corrupts your focus.'
            },
            'exercise': {
                title: 'EXERCISE — Physical Discipline Protocol',
                checklist: [
                    'Minimum 30 minutes of elevated heart rate daily. Walking doesn\'t count.',
                    'Strength training 3x per week. Compound movements: squat, deadlift, press.',
                    'Morning exercise > evening exercise. Sets your circadian rhythm.',
                    'No skipping because you\'re "tired." Tired is the default. Move anyway.',
                    'Cold shower after every workout. 2 minutes minimum. Builds mental toughness.',
                    'Track every workout. What gets measured gets managed.'
                ],
                suggestion: 'Add a "Morning Training" event at 6:00 AM tomorrow. 30 min minimum. If you skip it, I\'ll know — and there will be consequences.'
            },
            'nutrition': {
                title: 'NUTRITION — Fuel Protocol',
                checklist: [
                    'Protein with every meal. Minimum 1.6g per kg of bodyweight daily.',
                    'No processed sugar. It\'s poison dressed as pleasure.',
                    'Hydrate: 250ml water every 2 hours minimum. Your brain is 75% water.',
                    'Meal prep on Sundays. Decision fatigue kills discipline.',
                    'No eating after 8 PM. Your gut needs rest.',
                    'If you can\'t pronounce an ingredient, don\'t eat it.'
                ],
                suggestion: 'Your water target is 2000ml. If you haven\'t hit it by 3 PM, you\'re behind. Set hourly water alarms. Dehydration = degraded performance.'
            },
            'focus': {
                title: 'FOCUS — Mental Warfare Protocol',
                checklist: [
                    'Delete social media from your phone. Access only via desktop, time-boxed.',
                    'Use website blockers during deep work. willpower is finite; systems aren\'t.',
                    '5-minute meditation before each work block. Not optional.',
                    'Single-task ruthlessly. Context switching costs 23 minutes per switch.',
                    'Write down distracting thoughts on paper. Address them AFTER the work block.',
                    'Environment design: clean desk, noise-cancelling headphones, door closed.'
                ],
                suggestion: 'Remove all notification badges from your phone right now. Every badge is someone else\'s agenda stealing your attention. Take control.'
            }
        };

        function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        function addCoachMessage(text, type) {
            coachLog.push({ text, type, time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) });
            renderCoachLog();
        }

        function renderCoachLog() {
            const el = document.getElementById('coachLog');
            if (!coachLog.length) {
                el.innerHTML = '<div style="padding:20px;text-align:center;color:#4b5563;font-size:12px">The Coach is watching. Type a command or tap a quick action.</div>';
                return;
            }
            el.innerHTML = coachLog.map(m => {
                if (m.type === 'user') return `<div class="coach-msg user-cmd">${esc(m.text)}<div style="font-size:9px;color:#6b7280;margin-top:4px">${m.time}</div></div>`;
                const typeClass = m.type || '';
                const tagMap = { harsh: 'THE SPARTAN', motivate: 'MOTIVATION', advice: 'TACTICAL ADVICE', feedback: 'METRIC REVIEW' };
                const tag = tagMap[m.type] || 'COACH';
                return `<div class="coach-msg coach-resp ${typeClass}"><div class="coach-tag">${tag}</div>${m.text}<div style="font-size:9px;color:#4b5563;margin-top:4px">${m.time}</div></div>`;
            }).join('');
            el.scrollTop = el.scrollHeight;
        }

        function coachCommand(cmd) {
            addCoachMessage(cmd, 'user');
            processCoachCommand(cmd.toLowerCase());
        }

        function sendCoachCommand() {
            const input = document.getElementById('coachInput');
            const cmd = input.value.trim();
            if (!cmd) return;
            input.value = '';
            coachCommand(cmd);
        }

        // ---- VOICE INPUT ----
        let voiceRecognizer = null;
        let isListening = false;

        function toggleVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const micBtn = document.getElementById('coachMic');
            if (!SpeechRecognition) {
                addCoachMessage('Voice input is not supported in this browser. Try Chrome or Edge.', 'advice');
                return;
            }
            if (!voiceRecognizer) {
                voiceRecognizer = new SpeechRecognition();
                voiceRecognizer.lang = 'en-US';
                voiceRecognizer.interimResults = false;
                voiceRecognizer.maxAlternatives = 1;
                voiceRecognizer.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    const input = document.getElementById('coachInput');
                    input.value = text;
                    sendCoachCommand();
                };
                voiceRecognizer.onend = () => {
                    isListening = false;
                    if (micBtn) micBtn.classList.remove('active');
                };
            }
            if (isListening) {
                voiceRecognizer.stop();
                isListening = false;
                if (micBtn) micBtn.classList.remove('active');
                return;
            }
            isListening = true;
            if (micBtn) micBtn.classList.add('active');
            voiceRecognizer.start();
        }

        // ---- ALARMS ----
        function parseAlarmTime(cmd) {
            const match = cmd.match(/(\b\d{1,2}):(\d{2})\b/);
            if (!match) return null;
            const hours = Math.min(23, Math.max(0, parseInt(match[1], 10)));
            const minutes = Math.min(59, Math.max(0, parseInt(match[2], 10)));
            return { hours, minutes, text: match[0] };
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) return Promise.resolve('unsupported');
            if (Notification.permission === 'granted') return Promise.resolve('granted');
            return Notification.requestPermission();
        }

        function scheduleAlarmTask(time, label) {
            const now = new Date();
            const alarmTime = new Date();
            alarmTime.setHours(time.hours, time.minutes, 0, 0);
            if (alarmTime <= now) alarmTime.setDate(alarmTime.getDate() + 1);

            const task = {
                id: Date.now().toString(),
                title: label || 'Alarm',
                description: `Alarm at ${String(time.hours).padStart(2, '0')}:${String(time.minutes).padStart(2, '0')}`,
                completed: false,
                date: formatDateKey(alarmTime),
                alarmTime: `${String(time.hours).padStart(2, '0')}:${String(time.minutes).padStart(2, '0')}`,
                alarmTimestamp: alarmTime.getTime(),
                alarmFired: false
            };
            tasks.push(task);
            saveData();
            return task;
        }

        function fireAlarm(task) {
            task.alarmFired = true;
            saveData();
            const body = `${task.title} — ${task.alarmTime}`;
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Routine OS Alarm', { body });
            } else {
                alert(`ALARM: ${body}`);
            }
            addCoachMessage(`<strong>ALARM</strong><br>${body}`, 'harsh');
        }

        function checkAlarms() {
            const now = Date.now();
            tasks.filter(t => t.alarmTimestamp && !t.alarmFired && t.alarmTimestamp <= now).forEach(fireAlarm);
            tasks = tasks.filter(t => !t.alarmFired || !t.alarmTimestamp || (now - t.alarmTimestamp) < 86400000);
            saveData();
        }

        function fireEventAlarm(event) {
            event.alarmNotified = true;
            saveData();
            const body = `${event.title}${event.time ? ` — ${event.time}` : ''}`;
            if (appSettings.notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
                new Notification('Routine OS Event', { body });
            }
            if (event.alarmEnabled && appSettings.alarmsEnabled) {
                playAlarmSound();
            }
            addCoachMessage(`<strong>EVENT</strong><br>${body}`, 'advice');
        }

        function checkEventAlarms() {
            const now = Date.now();
            events.forEach(event => {
                if (!event.alarmTimestamp) return;
                if (!event.alarmNotified && event.alarmTimestamp <= now) {
                    fireEventAlarm(event);
                }
                if (event.type === 'recurring' && event.alarmTimestamp <= now) {
                    const next = new Date(event.alarmTimestamp);
                    next.setDate(next.getDate() + 1);
                    event.alarmTimestamp = next.getTime();
                    event.alarmNotified = false;
                }
            });
            saveData();
        }

        // ---- PROGRESS AWARENESS ----
        function getProgressSummary() {
            const today = formatDateKey(new Date());
            const todayTasks = tasks.filter(t => t.date === today);
            const activeTasks = todayTasks.filter(t => !t.skippedDates || !t.skippedDates.includes(today));
            const completedTasks = activeTasks.filter(t => t.completed);
            const skippedTasks = todayTasks.filter(t => t.skippedDates && t.skippedDates.includes(today));
            const todayEvents = events.filter(e => e.date === today);
            const waterPct = Math.round((metrics.water.current / metrics.water.target) * 100);

            return {
                today,
                tasks: { total: todayTasks.length, active: activeTasks.length, completed: completedTasks.length, skipped: skippedTasks.length, items: activeTasks },
                events: { total: todayEvents.length, items: todayEvents },
                water: { current: metrics.water.current, target: metrics.water.target, pct: waterPct },
                sleep: { hours: metrics.sleep.hours },
                exercise: { done: metrics.exercise.done }
            };
        }

        function processCoachCommand(cmd) {
            // ALARMS
            if (cmd.includes('alarm') || cmd.includes('notify') || cmd.includes('remind')) {
                const t = parseAlarmTime(cmd);
                if (!t) {
                    addCoachMessage('Give me a time like <strong>08:30</strong>. Example: "alarm 08:30 workout".', 'advice');
                    return;
                }
                requestNotificationPermission().then((perm) => {
                    const label = cmd.replace(t.text, '').replace(/alarm|notify|remind/gi, '').trim() || 'Alarm';
                    const alarmTask = scheduleAlarmTask(t, label);
                    const permText = perm === 'granted' ? 'Notifications enabled.' : 'Notifications blocked — I will use an on-screen alert.';
                    addCoachMessage(`<strong>ALARM TASK SET</strong><br>${alarmTask.alarmTime} — ${esc(label)}<br><em>${permText}</em>`, 'advice');
                });
                return;
            }

            if (cmd.includes('list alarms') || cmd.includes('alarms')) {
                const alarmTasks = tasks.filter(t => t.alarmTimestamp);
                if (!alarmTasks.length) {
                    addCoachMessage('No alarms scheduled. Use: <strong>alarm 08:30 wake up</strong>.', 'advice');
                    return;
                }
                const list = alarmTasks.map(a => `• ${a.alarmTime} — ${esc(a.title)}`).join('<br>');
                addCoachMessage(`<strong>ALARMS</strong><br>${list}`, 'advice');
                return;
            }
            // DATA MANAGEMENT
            if (cmd.includes('backup') || cmd.includes('save data') || cmd.includes('export')) {
                const data = {
                    events,
                    tasks,
                    metrics,
                    context: currentContext,
                    timestamp: new Date().toISOString()
                };
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `routine-os-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                addCoachMessage(`<strong>DATA BACKUP CREATED</strong><br>Downloaded: routine-os-backup-${new Date().toISOString().split('T')[0]}.json<br><em>Keep this file safe to restore your data later.</em>`, 'success');
                return;
            }

            if (cmd.includes('restore') || cmd.includes('import data')) {
                addCoachMessage(`<strong>DATA RESTORE</strong><br>To restore data:<br>1. Click the "Choose File" button below<br>2. Select your backup file<br>3. Data will be restored immediately<br><br><input type="file" id="restoreFile" accept=".json" style="color:#000;background:#fff;padding:8px;border-radius:4px;"><br><button onclick="restoreFromFile()" style="margin-top:8px;padding:8px 16px;background:#a855f7;color:#000;border:none;border-radius:4px;cursor:pointer;">Restore Now</button>`, 'advice');
                return;
            }

            if (cmd.includes('clear data') || cmd.includes('reset all') || cmd.includes('delete all')) {
                if (confirm('⚠️ This will delete ALL your data (tasks, events, metrics). This cannot be undone. Are you sure?')) {
                    if (confirm('🚨 Final confirmation: All data will be permanently deleted. Continue?')) {
                        events = [];
                        tasks = [];
                        metrics = {
                            water: { current: 0, target: 2000 },
                            sleep: { hours: null },
                            exercise: { done: false }
                        };
                        currentContext = 'calendar';
                        saveData();
                        renderContextContent(currentContext);
                        addCoachMessage('<strong>ALL DATA CLEARED</strong><br>Your scheduler has been reset to factory defaults.<br><em>Start fresh by adding new tasks and events.</em>', 'harsh');
                        return;
                    }
                }
                addCoachMessage('Data clear cancelled. Your data is safe.', 'advice');
                return;
            }

            if (cmd.includes('storage') || cmd.includes('memory') || cmd.includes('data info')) {
                const storageUsed = JSON.stringify(localStorage).length;
                const itemCount = {
                    events: events.length,
                    tasks: tasks.length,
                    metrics: Object.keys(metrics).length
                };
                addCoachMessage(`<strong>STORAGE INFO</strong><br>• Events: ${itemCount.events}<br>• Tasks: ${itemCount.tasks}<br>• Storage used: ~${Math.round(storageUsed/1024)}KB<br>• Last backup: ${localStorage.getItem('routine-os-backup') ? 'Available' : 'None'}<br><br>Commands: "backup", "clear data", "restore"`, 'info');
                return;
            }

            // PROGRESS REVIEW
            if (cmd.includes('progress') || cmd.includes('how am i') || cmd.includes('status') || cmd.includes('check')) {
                runProgressReview();
                return;
            }

            // RECOMMEND
            if (cmd.includes('recommend') || cmd.includes('suggest') || cmd.includes('what should') || cmd.includes('improve') || cmd.includes('next step') || cmd.includes('more reps') || cmd.includes('level up')) {
                runRecommendations();
                return;
            }

            // MOTIVATE
            if (cmd.includes('motivat') || cmd.includes('inspire') || cmd.includes('story') || cmd.includes('push me') || cmd.includes('fire me up')) {
                const story = rand(MOTIVATIONAL_STORIES);
                addCoachMessage(`<strong>${story.title}</strong><br><br>${story.text}`, 'motivate');
                return;
            }

            // ADVICE — match specific topics
            for (const [key, data] of Object.entries(ADVICE_DATABASE)) {
                if (cmd.includes(key) || (key === 'sleep hygiene' && cmd.includes('sleep')) || (key === 'work density' && (cmd.includes('work') || cmd.includes('productivity') || cmd.includes('focus')))) {
                    let html = `<strong>${data.title}</strong><br><br>`;
                    html += '<div style="margin:8px 0">';
                    data.checklist.forEach((item, i) => {
                        html += `<div style="margin-bottom:6px;padding-left:12px;border-left:1px solid rgba(168,85,247,.3)"><span style="color:#a855f7;font-weight:600">${i+1}.</span> ${item}</div>`;
                    });
                    html += '</div>';
                    html += `<div style="margin-top:10px;padding:8px 10px;background:rgba(168,85,247,.08);border:1px solid rgba(168,85,247,.2);border-radius:6px;font-size:12px"><strong style="color:#a855f7">SCHEDULE CHANGE:</strong> ${data.suggestion}</div>`;
                    addCoachMessage(html, 'advice');
                    return;
                }
            }

            // REVIEW METRICS (legacy alias)
            if (cmd.includes('review') || cmd.includes('metric')) {
                runProgressReview();
                return;
            }

            // GENERIC HARSH RESPONSE
            const p = getProgressSummary();
            const fallbackResponses = [
                `I don\'t have a direct command for "${esc(cmd)}" yet. Current snapshot: tasks ${p.tasks.completed}/${p.tasks.active}, water ${p.water.current}ml, sleep ${p.sleep.hours ?? 'not logged'}, exercise ${p.exercise.done ? 'done' : 'not done'}. Try: "progress" or "recommend".`,
                `Command not recognized. You\'ve got ${p.tasks.active} task${p.tasks.active === 1 ? '' : 's'} and ${p.events.total} event${p.events.total === 1 ? '' : 's'} today. If you want direction, ask for "progress" or "recommend".`,
                `"${esc(cmd)}" isn\'t in my playbook. If you want a review, say "progress". If you want the next move, say "recommend".`,
                `I can\'t parse that, but I can still help: ${p.tasks.completed}/${p.tasks.active} tasks done, water ${p.water.pct}%, sleep ${p.sleep.hours ?? 'not logged'}, exercise ${p.exercise.done ? 'done' : 'not done'}. What do you want to optimize?`
            ];
            addCoachMessage(rand(fallbackResponses), 'advice');
        }

        function runProgressReview() {
            const p = getProgressSummary();
            let score = 0;
            let lines = [];

            // TASK assessment
            if (p.tasks.active === 0) {
                lines.push(`<span style="color:#fbbf24">TASKS: No tasks set for today. Direction beats motivation. Add 2–3 concrete tasks to anchor the day.</span>`);
            } else {
                const taskPct = Math.round((p.tasks.completed / p.tasks.active) * 100);
                if (taskPct === 100) {
                    score += 1.5;
                    lines.push(`<span style="color:#4ade80">TASKS: ${p.tasks.completed}/${p.tasks.active} — all complete. Strong execution. Use the extra bandwidth for one high-impact task or recovery.</span>`);
                } else if (taskPct >= 50) {
                    score += 0.5;
                    lines.push(`<span style="color:#fbbf24">TASKS: ${p.tasks.completed}/${p.tasks.active} done (${taskPct}%). ${p.tasks.active - p.tasks.completed} remaining. You\'re in the middle — tighten focus and close the open loops.</span>`);
                } else {
                    lines.push(`<span style="color:#f87171">TASKS: ${p.tasks.completed}/${p.tasks.active} done (${taskPct}%). Momentum is low. ${p.tasks.skipped > 0 ? 'You skipped ' + p.tasks.skipped + ' task' + (p.tasks.skipped > 1 ? 's' : '') + '. Re-order tomorrow so the hardest item is first.' : 'Start with the smallest viable action and build.'}</span>`);
                }
            }

            // WATER assessment
            if (p.water.pct >= 100) { score++; lines.push(`<span style="color:#4ade80">WATER: ${p.water.current}ml — target met. Maintain a steady pace through the day.</span>`); }
            else if (p.water.pct >= 50) { score += 0.5; lines.push(`<span style="color:#fbbf24">WATER: ${p.water.current}ml (${p.water.pct}%) — halfway. Add one glass each hour to close the gap.</span>`); }
            else { lines.push(`<span style="color:#f87171">WATER: ${p.water.current}ml (${p.water.pct}%) — low. Hydration is a baseline performance lever. Fix it now.</span>`); }

            // SLEEP assessment
            if (p.sleep.hours === null) { lines.push(`<span style="color:#f87171">SLEEP: not logged — measure it so we can adjust. Log last night and we\'ll calibrate tonight.</span>`); }
            else if (p.sleep.hours >= 7 && p.sleep.hours <= 9) { score++; lines.push(`<span style="color:#4ade80">SLEEP: ${p.sleep.hours}h — solid range. Protect this with a consistent shutdown routine.</span>`); }
            else if (p.sleep.hours >= 5) { score += 0.5; lines.push(`<span style="color:#fbbf24">SLEEP: ${p.sleep.hours}h — short. Expect reduced focus today; schedule demanding work earlier.</span>`); }
            else { lines.push(`<span style="color:#f87171">SLEEP: ${p.sleep.hours}h — critical. Recovery is compromised; prioritize rest and simplify the day.</span>`); }

            // EXERCISE assessment
            if (p.exercise.done) { score++; lines.push(`<span style="color:#4ade80">EXERCISE: done — good. If it felt easy, increase intensity or volume next session.</span>`); }
            else { lines.push(`<span style="color:#f87171">EXERCISE: not done — movement is a keystone habit. Even 15–20 minutes counts.</span>`); }

            // SCHEDULE assessment
            if (p.events.total === 0) { lines.push(`<span style="color:#f87171">SCHEDULE: zero events. Block at least one focused work block or training slot.</span>`); }
            else { score += 0.5; lines.push(`<span style="color:#d8b4fe">SCHEDULE: ${p.events.total} event${p.events.total > 1 ? 's' : ''} planned. Protect the most important block and execute it first.</span>`); }

            // Overall verdict
            const maxScore = 5;
            const pct = Math.round((score / maxScore) * 100);
            let verdict, vtype;
            if (pct >= 70) {
                verdict = `<div style="margin-top:10px;padding:8px;background:rgba(34,197,94,.1);border:0.5px solid rgba(34,197,94,.3);border-radius:6px"><strong style="color:#4ade80">SCORE: ${pct}% — SOLID</strong><br>Good execution with room to refine. Type "recommend" to push one level higher.</div>`;
                vtype = 'advice';
            } else if (pct >= 40) {
                verdict = `<div style="margin-top:10px;padding:8px;background:rgba(251,191,36,.1);border:0.5px solid rgba(251,191,36,.3);border-radius:6px"><strong style="color:#fbbf24">SCORE: ${pct}% — MIDLINE</strong><br>Mixed signals. Pick one lever to fix today. Type "recommend" for a clear next step.</div>`;
                vtype = 'motivate';
            } else {
                verdict = `<div style="margin-top:10px;padding:8px;background:rgba(239,68,68,.1);border:0.5px solid rgba(239,68,68,.3);border-radius:6px"><strong style="color:#f87171">SCORE: ${pct}% — OFF-TRACK</strong><br>No shame, just data. Start with one corrective action and rebuild momentum.</div>`;
                vtype = 'harsh';
            }

            addCoachMessage(`<strong>PROGRESS REVIEW</strong><br><br>${lines.join('<br><br>')}${verdict}`, vtype);
        }

        function runRecommendations() {
            const p = getProgressSummary();
            let recs = [];

            // Task-based recommendations
            if (p.tasks.active === 0) {
                recs.push({cat: 'TASKS', text: 'You have zero tasks today. Add at least 3 concrete tasks right now. Not goals — actions. "Do 50 pushups" not "exercise more".'});
            } else if (p.tasks.completed === p.tasks.active && p.tasks.active > 0) {
                recs.push({cat: 'TASKS', text: `All ${p.tasks.completed} tasks complete. Time to raise the bar. Add 2 more challenging tasks. If it\'s not uncomfortable, you\'re not growing.`});
            } else if (p.tasks.completed === 0 && p.tasks.active > 0) {
                recs.push({cat: 'TASKS', text: `Zero tasks completed out of ${p.tasks.active}. Pick the easiest one. Do it in the next 5 minutes. Momentum builds from a single action.`});
            }
            if (p.tasks.skipped > 0) {
                recs.push({cat: 'DISCIPLINE', text: `You skipped ${p.tasks.skipped} task${p.tasks.skipped > 1 ? 's' : ''}. Tomorrow, do the skipped ones FIRST. Avoidance compounds. Attack what you fear.`});
            }

            // Exercise recommendations
            if (!p.exercise.done) {
                const hour = new Date().getHours();
                if (hour < 12) {
                    recs.push({cat: 'EXERCISE', text: 'Morning is prime time for training. Do 30 min now: 3 sets of pushups, squats, and planks to failure. Cold shower after. No negotiation.'});
                } else if (hour < 17) {
                    recs.push({cat: 'EXERCISE', text: 'Afternoon slot. 20 min HIIT: burpees, mountain climbers, jump squats. 40 sec on, 20 sec rest. 4 rounds. Start NOW.'});
                } else {
                    recs.push({cat: 'EXERCISE', text: 'Day is almost over and you haven\'t moved. Even 15 min counts: 100 pushups, 100 bodyweight squats, 2 min plank. Do it before bed or carry the shame to tomorrow.'});
                }
            } else {
                recs.push({cat: 'EXERCISE+', text: 'You trained today — good. Tomorrow, add more volume: extra set on each exercise, 10% more weight, or 5 more reps per set. Progressive overload is the only path to growth.'});
            }

            // Water recommendations
            if (p.water.pct < 50) {
                recs.push({cat: 'HYDRATION', text: `You\'re at ${p.water.current}ml. Drink 500ml right now. Set an alarm for every hour. Your cognitive performance is tanked until you fix this.`});
            } else if (p.water.pct < 100) {
                const remaining = p.water.target - p.water.current;
                recs.push({cat: 'HYDRATION', text: `${remaining}ml to go. That\'s ${Math.ceil(remaining / 250)} glasses. Space them across the remaining hours. Finish strong.`});
            }

            // Sleep recommendations
            if (p.sleep.hours !== null && p.sleep.hours < 7) {
                recs.push({cat: 'SLEEP', text: `${p.sleep.hours}h is not enough. Tonight: screens off by 9 PM, room at 18°C, in bed by 10 PM. Target 7.5h minimum. This is non-negotiable — everything else degrades without sleep.`});
            } else if (p.sleep.hours === null) {
                recs.push({cat: 'SLEEP', text: 'Log your sleep. You can\'t improve what you don\'t measure. Go to Metrics, enter last night\'s hours. Do it now, before you forget.'});
            }

            // Schedule recommendations
            if (p.events.total === 0) {
                recs.push({cat: 'SCHEDULE', text: 'Empty schedule. Block out tomorrow: deep work 6-8 AM, exercise 8-9 AM, focused work 10-12. Structure creates freedom. Add these events now.'});
            }

            // Format output
            let html = '<strong>RECOMMENDATIONS</strong><br><br>';
            recs.forEach(r => {
                html += `<div style="margin-bottom:10px;padding:8px 10px;background:rgba(168,85,247,.05);border-left:2px solid #a855f7;border-radius:0 6px 6px 0"><strong style="color:#a855f7;font-size:10px;text-transform:uppercase;letter-spacing:.5px">${r.cat}</strong><br><span style="font-size:13px">${r.text}</span></div>`;
            });

            if (recs.length === 0) {
                html += '<div style="padding:8px;background:rgba(34,197,94,.1);border:0.5px solid rgba(34,197,94,.3);border-radius:6px"><strong style="color:#4ade80">You\'re on track.</strong> All metrics green. Maintain discipline. The moment you think you\'ve made it is the moment you start slipping.</div>';
            }

            addCoachMessage(html, 'advice');
        }

        // 4-HOUR AUTO FEEDBACK
        function checkAutoFeedback() {
            const now = new Date();
            const hour = now.getHours();
            const feedbackHours = [8, 12, 16, 20];
            const currentSlot = feedbackHours.find(h => hour >= h && hour < h + 1);

            if (currentSlot !== undefined && lastFeedbackHour !== currentSlot) {
                lastFeedbackHour = currentSlot;
                const p = getProgressSummary();
                const failingWater = p.water.pct < 50;
                const failingSleep = p.sleep.hours !== null && p.sleep.hours < 6;
                const failingExercise = !p.exercise.done && hour >= 16;
                const failingTasks = p.tasks.active > 0 && p.tasks.completed === 0 && hour >= 12;

                if (failingWater || failingSleep || failingExercise || failingTasks) {
                    let msg = `<strong>${currentSlot}:00 CHECK-IN</strong><br><br>`;
                    if (failingTasks) msg += `Tasks: ${p.tasks.completed}/${p.tasks.active} complete. It\'s ${currentSlot}:00 and you haven\'t finished a single task. You\'re wasting the day.<br><br>`;
                    if (failingWater) msg += `Water at ${p.water.pct}%. By ${currentSlot}:00 you should be at ${Math.round((currentSlot/20)*100)}%. You\'re behind. Drink.<br><br>`;
                    if (failingSleep) msg += `${p.sleep.hours}h sleep logged. You\'re impaired. Compensate with discipline, not caffeine.<br><br>`;
                    if (failingExercise) msg += `It\'s ${currentSlot}:00 and you still haven\'t exercised. The day is running out.<br><br>`;
                    msg += `<em>This is your ${feedbackHours.indexOf(currentSlot) + 1}${['st','nd','rd','th'][feedbackHours.indexOf(currentSlot)]} check-in. I\'m watching.</em>`;
                    addCoachMessage(msg, 'harsh');

                    const banner = document.getElementById('feedbackBanner');
                    document.getElementById('feedbackBannerText').textContent = `${currentSlot}:00 — The Coach reviewed your progress. You\'re falling behind.`;
                    banner.classList.add('show');
                }
            }
        }

        function dismissFeedback() {
            document.getElementById('feedbackBanner').classList.remove('show');
        }


        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered:', registration))
                    .catch(error => console.log('SW registration failed:', error));
            });
        }
    </script>
</body>
</html>
